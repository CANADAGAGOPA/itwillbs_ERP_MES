<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.itwillbs.factron.mapper.vacation.VacationMapper">

    <select id="findMyVacations"
            resultType="com.itwillbs.factron.dto.vacation.VacationResponseDTO">
        SELECT
            e.id AS empId,
            e.name AS empName,
            e.position_code AS positionCode,
            (SELECT name FROM detail_sys_code WHERE detail_code = e.position_code) AS positionName,
            e.dept_code AS deptCode,
            (SELECT name FROM detail_sys_code WHERE detail_code = e.dept_code) AS deptName,
            TO_CHAR(vh.start_date, 'YYYY-MM-DD') AS vacationStartDate,
            TO_CHAR(vh.end_date, 'YYYY-MM-DD') AS vacationEndDate,
            vh.remark
        FROM
            vacation_history vh
                JOIN employee e ON vh.employee_id = e.id
                JOIN approval a ON vh.approval_id = a.id
        WHERE
            e.id = #{empId}
          AND a.approval_status_code = 'APV002'
          AND (
            (vh.start_date BETWEEN TO_DATE(#{startDate}, 'YYYY-MM-DD') AND TO_DATE(#{endDate}, 'YYYY-MM-DD'))
                OR
            (vh.end_date BETWEEN TO_DATE(#{startDate}, 'YYYY-MM-DD') AND TO_DATE(#{endDate}, 'YYYY-MM-DD'))
                OR
            (vh.start_date &lt;= TO_DATE(#{startDate}, 'YYYY-MM-DD') AND vh.end_date &gt;= TO_DATE(#{endDate}, 'YYYY-MM-DD'))
            )
        ORDER BY
            vh.start_date DESC
    </select>

    <select id="selectRandomHrManagerId" resultType="long">
        SELECT id
        FROM (
                 SELECT id
                 FROM employee
                 WHERE dept_code = 'DEP001'
                   AND quit_date IS NULL
                   AND id != #{empId}
                 ORDER BY DBMS_RANDOM.RANDOM
             )
        WHERE ROWNUM = 1
    </select>


    <select id="VacationCheck" resultType="boolean">
        SELECT CASE WHEN COUNT(*) > 0 THEN 1 ELSE 0 END
        FROM vacation_history vh
        JOIN approval a ON vh.approval_id = a.id
        WHERE vh.employee_id = #{empId}
        AND a.approval_status_code != 'APV003'
        AND (
        (vh.start_date BETWEEN TO_DATE(#{startDate}, 'YYYY-MM-DD') AND TO_DATE(#{endDate}, 'YYYY-MM-DD'))
        OR
        (vh.end_date BETWEEN TO_DATE(#{startDate}, 'YYYY-MM-DD') AND TO_DATE(#{endDate}, 'YYYY-MM-DD'))
        OR
        (vh.start_date &lt;= TO_DATE(#{startDate}, 'YYYY-MM-DD') AND vh.end_date &gt;= TO_DATE(#{endDate}, 'YYYY-MM-DD'))
        )
    </select>







</mapper>
